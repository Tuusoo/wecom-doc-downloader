<!DOCTYPE html><html lang="zh-CN"><head>
                <meta charset="UTF-8">
                <title>文件分块上传 - 文档 - 企业微信开发者中心</title>
                <link rel="stylesheet" href="../doc-style.css">
                </head>
                <body>
                <div id="js-ep-doc-cnt" class="ep-doc-area-cnt">
    <div class="ep-doc-area-top" id="js-ep-doc-cnt-title">
      <div class="ep-doc-area-title">
        文件分块上传
      </div>
      <div class="ep-doc-area-subtitle">最后更新：2023/03/09</div>
    </div>
    <div class="ep-doc-area-cherry cherry-markdown cherry-wecom" id="js-ep-doc-cnt-md"><div data-inline-code-theme="red" data-code-block-theme="coy"><dir class="toc" data-sign="66cb753813821957eb58bfc9b8152490-1" data-lines="1"><p class="toc-title">目录</p><li class="toc-li"><a href="#%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E5%88%9D%E5%A7%8B%E5%8C%96" class="level-2">分块上传初始化</a></li><li class="toc-li"><a href="#%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6" class="level-2">分块上传文件</a></li><li class="toc-li"><a href="#%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E5%AE%8C%E6%88%90" class="level-2">分块上传完成</a></li><li class="toc-li"><a href="#%E9%99%84%E5%BD%95-%E5%88%86%E5%9D%97%E7%B4%AF%E7%A7%AFsha%E8%AF%B4%E6%98%8E" class="level-2">附录-分块累积sha说明</a></li></dir><p data-sign="d88b964f37d71b4a5a16606e95a09399" data-type="p" data-lines="1">为了支持大文件上传，将文件进行分块，然后分别上传。</p><p data-sign="fe4f7e81d2a78c8b9cd09c9300eff732" data-type="p" data-lines="3">步骤如下：<br><img src="images/98004/f765cf0f.png" alt=""></p><ul data-sign="00e7d714bef78093e73332c1ddbf3b02list3" data-lines="3" class="cherry-list__default"><li>上传初始化：计算文件的分块（分块大小固定为<code>2M</code>，即<code>2097152字节</code>）的<code>累积sha</code>值（使用sha1算法），提交到企业微信开放平台。如果命中秒传，后续步骤则不需要再进行。</li><li>分块上传文件：分别上传分块文件（可并发上传，并发数建议不超过10）</li><li>标记上传完成：如果文件上传完整，返回上传成功的fileid</li></ul><p data-sign="br2" data-type="br" data-lines="2">&nbsp;</p><p data-sign="fd1c44250d466f3563712de3fc0f1925" data-type="p" data-lines="1"><strong>权限说明</strong></p><ul data-sign="173933f8c25047508e2cab80e5372eeelist4" data-lines="4" class="cherry-list__default"><li>企业需要使用<a href="#23784" rel="nofollow">“微盘”secret</a>所获取的accesstoken来调用（<a href="#10013/%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E8%8E%B7%E5%8F%96access_token" rel="nofollow">accesstoken如何获取？</a>）</li><li>自建应用需配置到“<a href="#23784" rel="nofollow">可调用应用</a>”列表中的应用secret所获取的accesstoken来调用（<a href="#10013/%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E8%8E%B7%E5%8F%96access_token" rel="nofollow">accesstoken如何获取？</a>）</li><li>第三方应用需具有“微盘”权限</li><li>代开发自建应用需具有“微盘”权限</li></ul><h2 id="%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E5%88%9D%E5%A7%8B%E5%8C%96" data-sign="01c7775253672dfeb8ded1d0e069efca" data-lines="2"><a class="anchor" href="#%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E5%88%9D%E5%A7%8B%E5%8C%96"></a>分块上传初始化</h2><p data-sign="4be3a8dc164a98155f3799ff55a0425a" data-type="p" data-lines="2">请求分块上传初始化接口，如果命中秒传，则流程结束，完成上传。</p><p data-sign="708e4449a950cab0b178e1462df096a1" data-type="p" data-lines="3"><strong>请求方式</strong>：POST（<strong>HTTPS</strong>）<br><strong>请求地址</strong>:  https://qyapi.weixin.qq.com/cgi-bin/wedrive/file_upload_init?access_token=ACCESS_TOKEN   </p><p data-sign="8a9affe8c49f861be4739ea1170e480a" data-type="p" data-lines="1"><strong>请求包体</strong></p><div data-sign="0111cbd53199b66aacaa85a8dc6cc311" data-type="codeBlock" data-lines="14">
      <pre class="language-json"><code class="language-json wrap"><span class="code-line"><span class="token punctuation">{</span></span>
<span class="code-line">    <span class="token property">"spaceid"</span><span class="token operator">:</span> <span class="token string">"SPACEID"</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token property">"fatherid"</span><span class="token operator">:</span> <span class="token string">"FATHERID"</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token property">"selected_ticket"</span><span class="token operator">:</span> <span class="token string">"SELECTED_TICKET"</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token property">"file_name"</span><span class="token operator">:</span> <span class="token string">"FILE_NAME"</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token property">"block_sha"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="code-line">        <span class="token string">"STATE1"</span><span class="token punctuation">,</span></span>
<span class="code-line">        <span class="token string">"STATE2"</span></span>
<span class="code-line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token property">"skip_push_card"</span><span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="code-line"><span class="token punctuation">}</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </div><p data-sign="54d2f7abd4f226094d9bdd35b3129b56" data-type="p" data-lines="2"><strong>参数说明</strong></p><div class="cherry-table-container" data-sign="ae0df257f9754b3e1c844c3d1731d559" data-lines="9">
        <table class="cherry-table"><thead><tr><th>参数</th><th>类型</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>spaceid</td><td>string</td><td>否</td><td>空间spaceid</td></tr><tr><td>fatherid</td><td>string</td><td>否</td><td>当前目录的fileid，根目录时为空间spaceid</td></tr><tr><td>selected_ticket</td><td>string</td><td>否</td><td><a href="#40357" rel="nofollow">微盘和文件选择器jsapi</a>返回的selectedTicket。若填此参数，则不需要填<code>spaceid</code>/<code>fatherid</code>。</td></tr><tr><td>file_name</td><td>string</td><td>是</td><td>文件名字</td></tr><tr><td>size</td><td>uint64</td><td>是</td><td>文件大小。最大支持20G</td></tr><tr><td>block_sha</td><td>string[]</td><td>是</td><td>文件分块累积sha值，按分块顺序填入数组。参考<a href="#40102/%E9%99%84%E5%BD%95-%E5%88%86%E5%9D%97%E7%B4%AF%E7%A7%AFsha%E8%AF%B4%E6%98%8E" rel="nofollow">附录-分块累积sha说明</a></td></tr><tr><td>skip_push_card</td><td>bool</td><td>否</td><td>文件创建完成时是否推送企业微信卡片。默认false，即默认推送卡片</td></tr></tbody></table></div><p data-sign="bb07173db5eae95dc5d87e72bcbb4b7c" data-type="p" data-lines="1">注意：<code>spaceid</code>/<code>fatherid</code>和<code>selected_ticket</code>必须填且仅填其中一组参数。</p><p data-sign="6394de01a40b78c07ec7af6eaecac7f9" data-type="p" data-lines="2"><strong>返回示例</strong></p><div data-sign="1e8e023ece13442739bfeb013fbe2b76" data-type="codeBlock" data-lines="10">
      <pre class="language-javascript"><code class="language-javascript wrap"><span class="code-line"><span class="token punctuation">{</span></span>
<span class="code-line">    <span class="token string">"errcode"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token string">"errmsg"</span><span class="token operator">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token string">"hit_exist"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token string">"upload_key"</span><span class="token operator">:</span> <span class="token string">"UPLOAD_KEY"</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token string">"fileid"</span><span class="token operator">:</span> <span class="token string">"FILEID"</span></span>
<span class="code-line"><span class="token punctuation">}</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </div><p data-sign="54d2f7abd4f226094d9bdd35b3129b56" data-type="p" data-lines="1"><strong>参数说明</strong></p><div class="cherry-table-container" data-sign="955fe79bc4e64458cb36a6e48b2f7cc2" data-lines="7">
        <table class="cherry-table"><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>errcode</td><td>int32</td><td>错误码</td></tr><tr><td>errmsg</td><td>string</td><td>错误码说明</td></tr><tr><td>hit_exist</td><td>bool</td><td>是否命中秒传</td></tr><tr><td>upload_key</td><td>string</td><td>文件上传凭证。不命中秒传时返回，作为file_upload_part参数</td></tr><tr><td>fileid</td><td>string</td><td>文件fileid。<strong>命中秒传时返回，此时上传流程完成</strong></td></tr></tbody></table></div><h2 id="%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6" data-sign="ff4eec101c795cbd1c979f641bbed1b8" data-lines="2"><a class="anchor" href="#%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"></a>分块上传文件</h2><p data-sign="f3946f3e4d25a1d7691d3ff003a35fe9" data-type="p" data-lines="2">将文件内容按2M分块，依次请求分块上传文件接口。</p><p data-sign="1b85437e6d3933619aaa74d7b06fd889" data-type="p" data-lines="3"><strong>请求方式</strong>：POST（<strong>HTTPS</strong>）<br><strong>请求地址</strong>:  https://qyapi.weixin.qq.com/cgi-bin/wedrive/file_upload_part?access_token=ACCESS_TOKEN   </p><p data-sign="8a9affe8c49f861be4739ea1170e480a" data-type="p" data-lines="1"><strong>请求包体</strong></p><div data-sign="87d4e20dde4c95c2f0ea7e7be7f7a8d0" data-type="codeBlock" data-lines="7">
      <pre class="language-json"><code class="language-json wrap"><span class="code-line"><span class="token punctuation">{</span></span>
<span class="code-line">    <span class="token property">"upload_key"</span><span class="token operator">:</span> <span class="token string">"UPLOAD_KEY"</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token property">"index"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token property">"file_base64_content"</span><span class="token operator">:</span> <span class="token string">"FILE_BASE64_CONTENT"</span></span>
<span class="code-line"><span class="token punctuation">}</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </div><p data-sign="54d2f7abd4f226094d9bdd35b3129b56" data-type="p" data-lines="2"><strong>参数说明</strong></p><div class="cherry-table-container" data-sign="20ffbf9b0aaa6045463af4678eb48e2a" data-lines="5">
        <table class="cherry-table"><thead><tr><th>参数</th><th>类型</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>upload_key</td><td>string</td><td>是</td><td>文件上传凭证。file_upload_init返回的upload_key</td></tr><tr><td>index</td><td>int32</td><td>是</td><td>文件分块号。文件内容按2M分块，<strong>从1开始</strong></td></tr><tr><td>file_base64_content</td><td>string</td><td>是</td><td>分块的文件内容base64。（注意：只需要填入文件内容的Base64，不需要添加任何如："data:application/x-javascript;base64" 的数据类型描述信息）</td></tr></tbody></table></div><p data-sign="6394de01a40b78c07ec7af6eaecac7f9" data-type="p" data-lines="2"><strong>返回示例</strong></p><div data-sign="7782e6e2c902a4f2257573bbdf4c8b87" data-type="codeBlock" data-lines="7">
      <pre class="language-json"><code class="language-json wrap"><span class="code-line"><span class="token punctuation">{</span></span>
<span class="code-line">    <span class="token property">"errcode"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token property">"errmsg"</span><span class="token operator">:</span> <span class="token string">"ok"</span></span>
<span class="code-line"><span class="token punctuation">}</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </div><p data-sign="54d2f7abd4f226094d9bdd35b3129b56" data-type="p" data-lines="1"><strong>参数说明</strong></p><div class="cherry-table-container" data-sign="5bc4e276b5f83ab5ad53694d56b99376" data-lines="4">
        <table class="cherry-table"><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>errcode</td><td>int32</td><td>错误码</td></tr><tr><td>errmsg</td><td>string</td><td>错误码说明</td></tr></tbody></table></div><h2 id="%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E5%AE%8C%E6%88%90" data-sign="88b9abebc1de958f3ffd13d5502493f5" data-lines="2"><a class="anchor" href="#%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0%E5%AE%8C%E6%88%90"></a>分块上传完成</h2><p data-sign="7699d099930da9753bc425406617a1df" data-type="p" data-lines="2">请求分块上传完成接口，流程结束，完成上传。</p><p data-sign="0e4bc40ec6a7ca07ba258fe26262c7d5" data-type="p" data-lines="3"><strong>请求方式</strong>：POST（<strong>HTTPS</strong>）<br><strong>请求地址</strong>:  https://qyapi.weixin.qq.com/cgi-bin/wedrive/file_upload_finish?access_token=ACCESS_TOKEN    </p><p data-sign="8a9affe8c49f861be4739ea1170e480a" data-type="p" data-lines="1"><strong>请求包体</strong></p><div data-sign="5d28ccc8312612a4aae4f7fb614f8e8b" data-type="codeBlock" data-lines="5">
      <pre class="language-json"><code class="language-json wrap"><span class="code-line"><span class="token punctuation">{</span></span>
<span class="code-line">    <span class="token property">"upload_key"</span><span class="token operator">:</span> <span class="token string">"UPLOAD_KEY"</span></span>
<span class="code-line"><span class="token punctuation">}</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </div><p data-sign="54d2f7abd4f226094d9bdd35b3129b56" data-type="p" data-lines="2"><strong>参数说明</strong></p><div class="cherry-table-container" data-sign="cf185b36e5c18769ce9f6aa70a5e90ca" data-lines="3">
        <table class="cherry-table"><thead><tr><th>参数</th><th>类型</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>upload_key</td><td>string</td><td>是</td><td>文件上传凭证。file_upload_init返回的upload_key</td></tr></tbody></table></div><p data-sign="6394de01a40b78c07ec7af6eaecac7f9" data-type="p" data-lines="2"><strong>返回示例</strong></p><div data-sign="4443f810dff232e440e585b6f36cc701" data-type="codeBlock" data-lines="8">
      <pre class="language-json"><code class="language-json wrap"><span class="code-line"><span class="token punctuation">{</span></span>
<span class="code-line">    <span class="token property">"errcode"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token property">"errmsg"</span><span class="token operator">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span></span>
<span class="code-line">    <span class="token property">"fileid"</span><span class="token operator">:</span> <span class="token string">"FILEID"</span></span>
<span class="code-line"><span class="token punctuation">}</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </div><p data-sign="54d2f7abd4f226094d9bdd35b3129b56" data-type="p" data-lines="2"><strong>参数说明</strong></p><div class="cherry-table-container" data-sign="79281d174f26f76ade33f6dbdf355083" data-lines="5">
        <table class="cherry-table"><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>errcode</td><td>int32</td><td>错误码</td></tr><tr><td>errmsg</td><td>string</td><td>错误码说明</td></tr><tr><td>fileid</td><td>string</td><td>文件fileid</td></tr></tbody></table></div><p data-sign="br2" data-type="br" data-lines="2">&nbsp;</p><h2 id="%E9%99%84%E5%BD%95-%E5%88%86%E5%9D%97%E7%B4%AF%E7%A7%AFsha%E8%AF%B4%E6%98%8E" data-sign="22f19e81c5bcecc00151beb4394bf506" data-lines="1"><a class="anchor" href="#%E9%99%84%E5%BD%95-%E5%88%86%E5%9D%97%E7%B4%AF%E7%A7%AFsha%E8%AF%B4%E6%98%8E"></a>附录-分块累积sha说明</h2><p data-sign="0c852370fc6bfd50f7ca1dc1602d24ec" data-type="p" data-lines="1"><img src="images/98004/0849514e.png" alt=""></p><p data-sign="3510b4b3dfc6f14691c75c2c11cc64c6" data-type="p" data-lines="1">分块的<code>累积sha值</code>计算过程如下：</p><ul data-sign="ac2dfeead036ff621a892d9e6a38002alist4" data-lines="4" class="cherry-list__default"><li>将要上传的文件内容，按2M分块；</li><li>对每一个分块，依次sha1_update；</li><li>每次update，记录当前的state，转成16进制，作为<strong>当前块</strong>的<code>累积sha值</code>；</li><li>当为最后一块（可能小于2M），update完再sha1_final得到的sha1值（即整个文件的sha1），作为<strong>最后一块</strong>的<code>累积sha值</code>。</li></ul><p data-sign="8cfe854073eabea8e718ac041f81ade7" data-type="p" data-lines="1">以上过程得到的sha值，保持顺序依次放到数组，作为<code>file_upload_init</code>接口的<code>block_sha</code>参数输入。</p><p data-sign="9fdb11af757cc0f1fef519052f2fed72" data-type="p" data-lines="2">相关示例代码见：<a href="https://github.com/wecomopen/file_block_digest" rel="nofollow">c++版本</a>。其他语言可根据以上流程自行实现，跟提供的c++版本实际测试结果对比验证。</p><p data-sign="b0f360da2cd2e0387ec0857acb910ee6" data-type="p" data-lines="2"><span style="color:#ff0000">提供了demo文件和其对应的接口调用关键参数的<a href="https://github.com/wecomopen/file_block_digest/blob/main/demo/README.md" rel="nofollow">说明文档</a>，可用来验证开发者逻辑实现的正确性。</span></p></div></div>
    </div>
                <script src="../doc-script.js"></script>
                
                
                </body></html>