<!DOCTYPE html><html lang="zh-CN"><head>
                <meta charset="UTF-8">
                <title>私密消息 - 文档 - 企业微信开发者中心</title>
                <link rel="stylesheet" href="../doc-style.css">
                </head>
                <body>
                <div id="js-ep-doc-cnt" class="ep-doc-area-cnt">
    <div class="ep-doc-area-top" id="js-ep-doc-cnt-title">
      <div class="ep-doc-area-title">
        私密消息
      </div>
      <div class="ep-doc-area-subtitle">最后更新：2021/05/27</div>
    </div>
    <div class="ep-doc-area-cherry cherry-markdown cherry-wecom" id="js-ep-doc-cnt-md"><div data-inline-code-theme="red" data-code-block-theme="coy"><dir data-sign="431eb51997c201f03e5696942dc02595-1" data-lines="1" class="toc"><p class="toc-title">目录</p><li class="toc-li"><a href="#%E6%A6%82%E8%BF%B0" class="level-2">概述</a></li><li class="toc-li"><a href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E" class="level-2">使用说明</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#1-%E5%88%86%E4%BA%AB" class="level-3">1. 分享</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#2-%E9%AA%8C%E8%AF%81" class="level-3">2. 验证</a></li><li class="toc-li"><a href="#%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E" class="level-2">接口说明</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#setshareattr" class="level-3">setShareAttr</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#getcontext" class="level-3">getContext</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#getshareinfo" class="level-3">getShareInfo</a></li><li class="toc-li"><a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" class="level-2">注意事项</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#state%E7%9A%84%E4%BD%9C%E7%94%A8" class="level-3">state的作用</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#curreceiver%E7%9A%84%E4%BD%9C%E7%94%A8" class="level-3">curReceiver的作用</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AEencrypteddata%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95" class="level-3">加密数据encryptedData解密算法</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#%E6%97%A7%E7%89%88%E6%9C%AC%E7%9A%84%E5%85%BC%E5%AE%B9" class="level-3">旧版本的兼容</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#%E5%BE%AE%E4%BF%A1%E5%AE%A2%E6%88%B7%E4%BC%9A%E8%AF%9D%E7%9A%84%E9%97%AE%E9%A2%98" class="level-3">微信客户会话的问题</a></li></dir><h2 id="%E6%A6%82%E8%BF%B0" data-sign="9a8437ccee43ad66c084b8dfd3d259d3" data-lines="2"><a class="anchor" href="#%E6%A6%82%E8%BF%B0"></a>概述</h2><p data-sign="d65f42aa4b8bc309a84df09b5451ef9d" data-type="p" data-lines="1">企业微信从3.1.8版本开始，支持将网页或小程序转发时设置为私密消息。当企业成员将网页或小程序分享给其他成员或群聊后，其他成员打开网页或小程序时，开发者可判断当前用户是否为消息的直接接收人。同时，私密消息具有不可二次转发性，即在3.1.8及以后的版本，私密消息没有转发入口。企业微信的私密消息与微信小程序私密消息类似，不过有几个差异点：</p><ul data-sign="3df3bbea6d2714ef9e1903343f3770e8list4" data-lines="4" class="cherry-list__default"><li>企业微信的私密消息支持网页与小程序。</li><li>企业微信的私密消息通过调用setShareAttr进行声明，声明时指定withShareTicket为true，即将消息声明带shareticket，在企业微信里，带shareticket的消息即为私密消息。</li><li>企业微信的私密消息没有引入动态消息activity_id，而是以开发者自定义的state值来替代。</li><li>企业微信通过getContext返回shareTicket，并通过getShareInfo返回加密的群id、state值、当前用户open_userid.</li></ul><p data-sign="br2" data-type="br" data-lines="2">&nbsp;</p><h2 data-sign="1dd520b3f66858b911eedf69b683e437" data-lines="1" id="%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"><a class="anchor" href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"></a>使用说明</h2><h3 id="1-%E5%88%86%E4%BA%AB" data-sign="19fe5768d39cfc00c43bee8ba7f6b651" data-lines="2"><a class="anchor" href="#1-%E5%88%86%E4%BA%AB"></a>1. 分享</h3><p data-sign="78f98cebc44c9ad03a83696b366e4c32" data-type="p" data-lines="1">在用户分享网页或小程序前，先调用<a href="#setShareAttr" rel="nofollow">setShareAttr</a>，将本页面的转发声明为shareticket消息。声明之后，该页面被转发之后都有shareticket属性，转发途径包括：右上角菜单、聊天附件栏页面的底部“发送”按钮、聊天附件栏或聊天工具栏调用<a href="#21264" rel="nofollow">sendChatMessage</a>接口等。</p><p data-sign="154ecdbfbf5bfbbc73a4ae296e28c57d" data-type="p" data-lines="3">场景一： 个人分享给个人<br>A --&gt; B</p><p data-sign="f55983fe0c3c4ec37b7a1682d2e868fd" data-type="p" data-lines="3">场景二： 个人分享给群<br>A --&gt; [B, C, D, E]</p><p data-sign="d07c99df919a153b20847833139136a3" data-type="p" data-lines="2">注意：分享之后，被移出群的成员将不再有该shareticket消息的访问权限，而后来进群的成员则自动拥有了访问权限。</p><p data-sign="br2" data-type="br" data-lines="2">&nbsp;</p><h3 id="2-%E9%AA%8C%E8%AF%81" data-sign="f9bb460fe27bc6ae0eb974b135dfb663" data-lines="1"><a class="anchor" href="#2-%E9%AA%8C%E8%AF%81"></a>2. 验证</h3><p data-sign="7c2773224c9b817204ff21c7695feaaf" data-type="p" data-lines="1">带有shareticket的消息卡片，用户打开网页或小程序，开发者调用<a href="#21951" rel="nofollow">getContext</a>时，可以得到shareticket。再根据shareticket调用<a href="#getShareInfo" rel="nofollow">getShareInfo</a>，如果当前用户是消息的直接接收者，则企业微信会返回加密的encryptedData，如果不是直接接收者，则接口会返回错误。</p><p data-sign="br2" data-type="br" data-lines="2">&nbsp;</p><h2 id="%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E" data-sign="3ee63dd18c817dfdbd95d92975b82eab" data-lines="1"><a class="anchor" href="#%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E"></a>接口说明</h2><h3 id="setshareattr" data-sign="19c6706b4cc143b2b77e0c4dd7e3bc6d" data-lines="2"><a class="anchor" href="#setshareattr"></a>setShareAttr</h3><p data-sign="432b04f929a06cfd90064af95a4ca836" data-type="p" data-lines="1">接口定义</p><div data-sign="60d60bd35a09114be0b1050e285c6795" data-type="codeBlock" data-lines="9">
      <pre class="language-javascript"><code class="language-javascript wrap"><span class="code-line">wx<span class="token punctuation">.</span>qy<span class="token punctuation">.</span><span class="token function">setShareAttr</span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="code-line">	withShareTicket<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="code-line">    state<span class="token operator">:</span> <span class="token string">"STATE"</span><span class="token punctuation">,</span></span>
<span class="code-line">	<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="code-line">    	</span>
<span class="code-line">  <span class="token punctuation">}</span></span>
<span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </div><blockquote data-sign="fc945dd0210b259761837464eecb142e_2" data-lines="2">必须先调用过wx.qy.login，且session_key未过期，开发者可调用checkSession 检查当前登录态<br>当前成员必须在应用的可见范围</blockquote><p data-sign="388e6f5733cf195e3810e477b2972d11" data-type="p" data-lines="2"><strong>传入参数</strong></p><div class="cherry-table-container" data-sign="a86f38c539351164117576f8ecd1c5ac" data-lines="4">
        <table class="cherry-table"><thead><tr><th>参数名</th><th>类型</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>withShareTicket</td><td>Boolean</td><td>否</td><td>默认为false</td></tr><tr><td>state</td><td>String</td><td>否</td><td>详见<a href="#state%E7%9A%84%E4%BD%9C%E7%94%A8" rel="nofollow">state的作用</a></td></tr></tbody></table></div><p data-sign="br3" data-type="br" data-lines="3">&nbsp;</p><h3 id="getcontext" data-sign="3d28d5e69c85aba8b79697c8c0683830" data-lines="1"><a class="anchor" href="#getcontext"></a>getContext</h3><p data-sign="5dfb1ac33f08c72ee4921e4fdc68d503" data-type="p" data-lines="2">接口定义详见“<a href="#21951" rel="nofollow">wx.qy.getContext</a>”，以下是示例代码：</p><div data-sign="e4684aa50f40c0b538a6c9f9288af0fe" data-type="codeBlock" data-lines="9">
      <pre class="language-javascript"><code class="language-javascript wrap"><span class="code-line">wx<span class="token punctuation">.</span>qy<span class="token punctuation">.</span><span class="token function">getContext</span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="code-line">  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="code-line">    <span class="token keyword">var</span> entry <span class="token operator">=</span> res<span class="token punctuation">.</span>entry<span class="token punctuation">;</span> <span class="token comment">//返回进入小程序的入口类型</span></span>
<span class="code-line">	<span class="token keyword">var</span> shareTicket <span class="token operator">=</span> res<span class="token punctuation">.</span>shareTicket<span class="token punctuation">;</span></span>
<span class="code-line">  <span class="token punctuation">}</span></span>
<span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </div><p data-sign="br3" data-type="br" data-lines="3">&nbsp;</p><h3 id="getshareinfo" data-sign="43c1d5ec57c739c02984dc08816b12f4" data-lines="1"><a class="anchor" href="#getshareinfo"></a>getShareInfo</h3><p data-sign="432b04f929a06cfd90064af95a4ca836" data-type="p" data-lines="1">接口定义</p><div data-sign="de3d4de964a020c5e27a05f3d4e837da" data-type="codeBlock" data-lines="9">
      <pre class="language-javascript"><code class="language-javascript wrap"><span class="code-line">wx<span class="token punctuation">.</span>qy<span class="token punctuation">.</span><span class="token function">getShareInfo</span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="code-line">  shareTicket<span class="token operator">:</span><span class="token string">"xxxx"</span><span class="token punctuation">,</span></span>
<span class="code-line">  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="code-line">    <span class="token keyword">var</span> encryptedData <span class="token operator">=</span> res<span class="token punctuation">.</span>encryptedData<span class="token punctuation">;</span> <span class="token comment">//转发信息的加密数据</span></span>
<span class="code-line">	<span class="token keyword">var</span> iv <span class="token operator">=</span> res<span class="token punctuation">.</span>iv<span class="token punctuation">;</span> <span class="token comment">//加密算法的初始向量 </span></span>
<span class="code-line">  <span class="token punctuation">}</span></span>
<span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </div><blockquote data-sign="9df41d677629c63ce26fa1bd4eab3dae_1" data-lines="1">需要wx.qy.login，且session_key未过期，开发者可调用checkSession 检查当前登录态<br>当前成员必须在应用的可见范围</blockquote><p data-sign="388e6f5733cf195e3810e477b2972d11" data-type="p" data-lines="2"><strong>传入参数</strong></p><div class="cherry-table-container" data-sign="3ef2515b896c9ab7ad53a65bff159e01" data-lines="3">
        <table class="cherry-table"><thead><tr><th>参数名</th><th>类型</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>shareTicket</td><td>String</td><td>是</td><td>调用<a href="#21951" rel="nofollow">getContext</a>时获取到的shareTicket</td></tr></tbody></table></div><p data-sign="87ca8c911e5ab495a05e76b2522fc7d9" data-type="p" data-lines="2"><strong>返回结果</strong></p><div class="cherry-table-container" data-sign="1930222c65b7af40bd549f1e8d254522" data-lines="4">
        <table class="cherry-table"><thead><tr><th>参数名</th><th>类型</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>encryptedData</td><td>String</td><td>是</td><td>转发信息的加密数据</td></tr><tr><td>iv</td><td>String</td><td>是</td><td>加密算法的初始向量</td></tr></tbody></table></div><p data-sign="b908023964f96bbf8387d5890e632d0b" data-type="p" data-lines="1">将encryptedData解密得到的开放数据为以下 json 结构（解密算法详见“<a href="#%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AEencryptedData%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95" rel="nofollow">加密数据encryptedData解密算法</a>”）：</p><div data-sign="90513a6e134516a92ea1a69ec9cffcd1" data-type="codeBlock" data-lines="7">
      <pre class="language-javascript"><code class="language-javascript wrap"><span class="code-line"><span class="token punctuation">{</span></span>
<span class="code-line">     <span class="token string">"chatId"</span><span class="token operator">:</span> <span class="token string">"CHATID"</span><span class="token punctuation">,</span></span>
<span class="code-line">     <span class="token string">"state"</span><span class="token operator">:</span> <span class="token string">"STATE"</span><span class="token punctuation">,</span></span>
<span class="code-line">     <span class="token string">"curReceiver"</span><span class="token operator">:</span> <span class="token string">"CURRECEIVER"</span><span class="token punctuation">,</span></span>
<span class="code-line"><span class="token punctuation">}</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </div><p data-sign="65e13d8230650d77022a06c092fd0912" data-type="p" data-lines="1">json结构说明：</p><div class="cherry-table-container" data-sign="ba8f14f3fa7b630229a85e71e5bc3a85" data-lines="5">
        <table class="cherry-table"><thead><tr><th>参数名</th><th>类型</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>chatId</td><td>String</td><td>否</td><td>群聊时返回，群id，单聊时返回空字符串</td></tr><tr><td>state</td><td>String</td><td>否</td><td>setShareAttr时传入的state参数，详见<a href="#state%E7%9A%84%E4%BD%9C%E7%94%A8" rel="nofollow">state的作用</a></td></tr><tr><td>curReceiver</td><td>String</td><td>否</td><td>当前接收者的userid，对于自建应用返回的是明文userid，对于第三方应用返回的是加密的open_userid。详见<a href="#curReceiver%E7%9A%84%E4%BD%9C%E7%94%A8" rel="nofollow">curReceiver的作用</a></td></tr></tbody></table></div><h2 id="%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" data-sign="f5f4202c15f2196a2f817ee2ddd9496d" data-lines="2"><a class="anchor" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"></a>注意事项</h2><h3 id="state%E7%9A%84%E4%BD%9C%E7%94%A8" data-sign="35f5698555284b0d502735ec51170851" data-lines="2"><a class="anchor" href="#state%E7%9A%84%E4%BD%9C%E7%94%A8"></a>state的作用</h3><p data-sign="785293ae5367095cf1cd3a0b14074554" data-type="p" data-lines="1">调用setShareAttr时，可以传一个state参数，该参数值由开发者自由指定。shareticket消息分享之后，当接收者打开消息的H5页面或小程序时，开发者调用getShareInfo，企业微信会将state值加密返回，开发者可在后台解密并加以校验。</p><h3 id="curreceiver%E7%9A%84%E4%BD%9C%E7%94%A8" data-sign="545ed669edcc5d6f6db50b04f0604ed0" data-lines="2"><a class="anchor" href="#curreceiver%E7%9A%84%E4%BD%9C%E7%94%A8"></a>curReceiver的作用</h3><p data-sign="5c21c96e95311a2cd89700cbdfb01ff7" data-type="p" data-lines="2">用户进入网页时，网页通过oauth2可获得用户的userid（第三方应用可获得open_userid）。调用getShareInfo时，企业微信会将当前用户的userid或open_userid通过curReceiver加密在encryptedData里返回。<br>为了避免encryptedData被重放攻击，我们建议开发者检查curReceiver与oauth2获得的userid（或open_userid）是否一致。</p><h3 id="%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AEencrypteddata%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95" data-sign="a1902d668ad51f20e10dae4354085240" data-lines="2"><a class="anchor" href="#%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AEencrypteddata%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95"></a>加密数据encryptedData解密算法</h3><ol data-sign="c9462a151cdcb253b2d9096793842b1flist4" data-lines="4" class="cherry-list__default" start="1"><li>解密使用的算法为 AES-128-CBC，数据采用PKCS#7填充。</li><li>对称解密的目标密文为 Base64_Decode(encryptedData)。</li><li>对称解密秘钥 aeskey = Base64_Decode(<a href="#16056" rel="nofollow">session_key</a>), aeskey长度为16字节。</li><li>对称解密算法初始向量 为Base64_Decode(iv)，其中iv由数据接口返回。</li></ol><p data-sign="br2" data-type="br" data-lines="2">&nbsp;</p><h3 id="%E6%97%A7%E7%89%88%E6%9C%AC%E7%9A%84%E5%85%BC%E5%AE%B9" data-sign="46411c6430f73ec2620f83c82db88bce" data-lines="1"><a class="anchor" href="#%E6%97%A7%E7%89%88%E6%9C%AC%E7%9A%84%E5%85%BC%E5%AE%B9"></a>旧版本的兼容</h3><p data-sign="0a8b3060520dbfaab6b82b3ef168d723" data-type="p" data-lines="1">在企业微信的旧版本里，shareticket消息是可以长按转发到其他会话里的，所以开发者一定要通过getShareInfo的返回值来检查当前用户是否消息的直接接收者。</p><h3 id="%E5%BE%AE%E4%BF%A1%E5%AE%A2%E6%88%B7%E4%BC%9A%E8%AF%9D%E7%9A%84%E9%97%AE%E9%A2%98" data-sign="fb929dc3468688c6ffb5f2713f6a4ee0" data-lines="2"><a class="anchor" href="#%E5%BE%AE%E4%BF%A1%E5%AE%A2%E6%88%B7%E4%BC%9A%E8%AF%9D%E7%9A%84%E9%97%AE%E9%A2%98"></a>微信客户会话的问题</h3><p data-sign="ab613219f64c91559e77a3bbe114d084" data-type="p" data-lines="1">企业微信的shareticket属性不支持同步到微信，当shareticket消息分享到包含微信用户的会话中，用户在微信打开时是没法获取到shareticket的。</p></div></div>
    </div>
                <script src="../doc-script.js"></script>
                
                
                </body></html>