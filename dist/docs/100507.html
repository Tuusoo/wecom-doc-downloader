<!DOCTYPE html><html lang="zh-CN"><head>
                <meta charset="UTF-8">
                <title>概述 - 文档 - 企业微信开发者中心</title>
                <link rel="stylesheet" href="../doc-style.css">
                </head>
                <body>
                <div id="js-ep-doc-cnt" class="ep-doc-area-cnt">
    <div class="ep-doc-area-top" id="js-ep-doc-cnt-title">
      <div class="ep-doc-area-title">
        概述
      </div>
      <div class="ep-doc-area-subtitle">最后更新：2024/11/28</div>
    </div>
    <div class="ep-doc-area-cherry cherry-markdown cherry-wecom" id="js-ep-doc-cnt-md"><div data-inline-code-theme="red" data-code-block-theme="coy"><dir class="toc" data-sign="6cad4d5c964341cb35fa7e402f23f38c-1" data-lines="1"><p class="toc-title">目录</p><li class="toc-li"><a href="#%E6%A6%82%E8%BF%B0" class="level-2">概述</a></li><li class="toc-li"><a href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E" class="level-2">使用说明</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#1-%E5%88%86%E4%BA%AB" class="level-3">1. 分享</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#2-%E9%AA%8C%E8%AF%81" class="level-3">2. 验证</a></li><li class="toc-li"><a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" class="level-2">注意事项</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#state%E7%9A%84%E4%BD%9C%E7%94%A8" class="level-3">state的作用</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#curreceiver%E7%9A%84%E4%BD%9C%E7%94%A8" class="level-3">curReceiver的作用</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AEencrypteddata%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95" class="level-3">加密数据encryptedData解密算法</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#%E6%97%A7%E7%89%88%E6%9C%AC%E7%9A%84%E5%85%BC%E5%AE%B9" class="level-3">旧版本的兼容</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#%E5%BE%AE%E4%BF%A1%E5%AE%A2%E6%88%B7%E4%BC%9A%E8%AF%9D%E7%9A%84%E9%97%AE%E9%A2%98" class="level-3">微信客户会话的问题</a></li></dir><h2 id="%E6%A6%82%E8%BF%B0" data-sign="9a8437ccee43ad66c084b8dfd3d259d3" data-lines="2"><a class="anchor" href="#%E6%A6%82%E8%BF%B0"></a>概述</h2><p data-sign="d65f42aa4b8bc309a84df09b5451ef9d" data-type="p" data-lines="1">企业微信从3.1.8版本开始，支持将网页或小程序转发时设置为私密消息。当企业成员将网页或小程序分享给其他成员或群聊后，其他成员打开网页或小程序时，开发者可判断当前用户是否为消息的直接接收人。同时，私密消息具有不可二次转发性，即在3.1.8及以后的版本，私密消息没有转发入口。企业微信的私密消息与微信小程序私密消息类似，不过有几个差异点：</p><ul data-sign="3df3bbea6d2714ef9e1903343f3770e8list4" data-lines="4" class="cherry-list__default"><li>企业微信的私密消息支持网页与小程序。</li><li>企业微信的私密消息通过调用setShareAttr进行声明，声明时指定withShareTicket为true，即将消息声明带shareticket，在企业微信里，带shareticket的消息即为私密消息。</li><li>企业微信的私密消息没有引入动态消息activity_id，而是以开发者自定义的state值来替代。</li><li>企业微信通过getContext返回shareTicket，并通过getShareInfo返回加密的群id、state值、当前用户open_userid.</li></ul><h2 id="%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E" data-sign="1dd520b3f66858b911eedf69b683e437" data-lines="1"><a class="anchor" href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"></a>使用说明</h2><h3 id="1-%E5%88%86%E4%BA%AB" data-sign="19fe5768d39cfc00c43bee8ba7f6b651" data-lines="1"><a class="anchor" href="#1-%E5%88%86%E4%BA%AB"></a>1. 分享</h3><p data-sign="b78a34422d37eb0ada2dd53aedbce9ea" data-type="p" data-lines="1">在用户分享网页或小程序前，先调用<a href="#56726" rel="nofollow">setShareAttr</a>，将本页面的转发声明为shareticket消息。声明之后，该页面被转发之后都有shareticket属性，转发途径包括：右上角菜单、调用<a href="#14911/%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BD%AC%E5%8F%91%E5%88%B0%E4%BC%9A%E8%AF%9D" rel="nofollow">shareAppMessage</a>接口、聊天附件栏页面的底部“发送”按钮、聊天附件栏或聊天工具栏调用<a href="#29574" rel="nofollow">sendChatMessage</a>接口等。</p><p data-sign="154ecdbfbf5bfbbc73a4ae296e28c57d" data-type="p" data-lines="3">场景一： 个人分享给个人<br>A --&gt; B</p><p data-sign="f55983fe0c3c4ec37b7a1682d2e868fd" data-type="p" data-lines="3">场景二： 个人分享给群<br>A --&gt; [B, C, D, E]</p><p data-sign="d07c99df919a153b20847833139136a3" data-type="p" data-lines="2">注意：分享之后，被移出群的成员将不再有该shareticket消息的访问权限，而后来进群的成员则自动拥有了访问权限。</p><h3 id="2-%E9%AA%8C%E8%AF%81" data-sign="f9bb460fe27bc6ae0eb974b135dfb663" data-lines="2"><a class="anchor" href="#2-%E9%AA%8C%E8%AF%81"></a>2. 验证</h3><p data-sign="93eac8d25c3fd5e55b7756c1101eac92" data-type="p" data-lines="1">带有shareticket的消息卡片，用户打开网页或小程序，开发者调用<a href="#56727" rel="nofollow">getContext</a>时，可以得到shareticket。再根据shareticket调用<a href="#56728" rel="nofollow">getShareInfo</a>，如果当前用户是消息的直接接收者，则企业微信会返回加密的encryptedData，如果不是直接接收者，则接口会返回错误。</p><h2 id="%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" data-sign="f5f4202c15f2196a2f817ee2ddd9496d" data-lines="1"><a class="anchor" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"></a>注意事项</h2><h3 id="state%E7%9A%84%E4%BD%9C%E7%94%A8" data-sign="35f5698555284b0d502735ec51170851" data-lines="2"><a class="anchor" href="#state%E7%9A%84%E4%BD%9C%E7%94%A8"></a>state的作用</h3><p data-sign="785293ae5367095cf1cd3a0b14074554" data-type="p" data-lines="1">调用setShareAttr时，可以传一个state参数，该参数值由开发者自由指定。shareticket消息分享之后，当接收者打开消息的H5页面或小程序时，开发者调用getShareInfo，企业微信会将state值加密返回，开发者可在后台解密并加以校验。</p><h3 id="curreceiver%E7%9A%84%E4%BD%9C%E7%94%A8" data-sign="545ed669edcc5d6f6db50b04f0604ed0" data-lines="2"><a class="anchor" href="#curreceiver%E7%9A%84%E4%BD%9C%E7%94%A8"></a>curReceiver的作用</h3><p data-sign="5c21c96e95311a2cd89700cbdfb01ff7" data-type="p" data-lines="2">用户进入网页时，网页通过oauth2可获得用户的userid（第三方应用可获得open_userid）。调用getShareInfo时，企业微信会将当前用户的userid或open_userid通过curReceiver加密在encryptedData里返回。<br>为了避免encryptedData被重放攻击，我们建议开发者检查curReceiver与oauth2获得的userid（或open_userid）是否一致。</p><h3 id="%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AEencrypteddata%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95" data-sign="a1902d668ad51f20e10dae4354085240" data-lines="2"><a class="anchor" href="#%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AEencrypteddata%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95"></a>加密数据encryptedData解密算法</h3><ol data-sign="7d4e6a0dc5a4e4f1c09ba46e63e60dcalist4" data-lines="4" class="cherry-list__default" start="1"><li>解密使用的算法为 AES-128-CBC，数据采用PKCS#7填充。</li><li>对称解密的目标密文为 Base64_Decode(encryptedData)。</li><li>对称解密秘钥 aeskey = Base64_Decode(<a href="#14924/#%E8%8E%B7%E5%8F%96%E5%BA%94%E7%94%A8-jsapi-ticket" rel="nofollow">应用身份使用的ticket</a>), aeskey长度为16字节。</li><li>对称解密算法初始向量 为Base64_Decode(iv)，其中iv由数据接口返回。</li></ol><h3 id="%E6%97%A7%E7%89%88%E6%9C%AC%E7%9A%84%E5%85%BC%E5%AE%B9" data-sign="46411c6430f73ec2620f83c82db88bce" data-lines="2"><a class="anchor" href="#%E6%97%A7%E7%89%88%E6%9C%AC%E7%9A%84%E5%85%BC%E5%AE%B9"></a>旧版本的兼容</h3><p data-sign="0a8b3060520dbfaab6b82b3ef168d723" data-type="p" data-lines="1">在企业微信的旧版本里，shareticket消息是可以长按转发到其他会话里的，所以开发者一定要通过getShareInfo的返回值来检查当前用户是否消息的直接接收者。</p><h3 id="%E5%BE%AE%E4%BF%A1%E5%AE%A2%E6%88%B7%E4%BC%9A%E8%AF%9D%E7%9A%84%E9%97%AE%E9%A2%98" data-sign="fb929dc3468688c6ffb5f2713f6a4ee0" data-lines="2"><a class="anchor" href="#%E5%BE%AE%E4%BF%A1%E5%AE%A2%E6%88%B7%E4%BC%9A%E8%AF%9D%E7%9A%84%E9%97%AE%E9%A2%98"></a>微信客户会话的问题</h3><p data-sign="ab613219f64c91559e77a3bbe114d084" data-type="p" data-lines="1">企业微信的shareticket属性不支持同步到微信，当shareticket消息分享到包含微信用户的会话中，用户在微信打开时是没法获取到shareticket的。</p></div></div>
    </div>
                <script src="../doc-script.js"></script>
                
                
                </body></html>