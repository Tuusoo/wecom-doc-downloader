<!DOCTYPE html><html lang="zh-CN"><head>
                <meta charset="UTF-8">
                <title>开始开发 - 文档 - 企业微信开发者中心</title>
                <link rel="stylesheet" href="../doc-style.css">
                </head>
                <body>
                <div id="js-ep-doc-cnt" class="ep-doc-area-cnt">
    <div class="ep-doc-area-top" id="js-ep-doc-cnt-title">
      <div class="ep-doc-area-title">
        开始开发
      </div>
      <div class="ep-doc-area-subtitle">最后更新：2019/08/08</div>
    </div>
    <div class="ep-doc-area-cherry cherry-markdown cherry-wecom" id="js-ep-doc-cnt-md"><div data-inline-code-theme="red" data-code-block-theme="coy"><dir data-sign="4d2d6d8633da74f981eacefdeab90689-1" data-lines="1" class="toc"><p class="toc-title">目录</p><li class="toc-li"><a href="#oauth2%E7%AE%80%E4%BB%8B" class="level-2">OAuth2简介</a></li><li class="toc-li"><a href="#%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1oauth2%E6%8E%A5%E5%85%A5%E6%B5%81%E7%A8%8B" class="level-2">企业微信OAuth2接入流程</a></li><li class="toc-li"><a href="#%E4%BD%BF%E7%94%A8oauth2%E5%89%8D%E9%A1%BB%E7%9F%A5" class="level-2">使用OAuth2前须知</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#%E5%85%B3%E4%BA%8E%E7%BD%91%E9%A1%B5%E6%8E%88%E6%9D%83%E7%9A%84%E5%8F%AF%E4%BF%A1%E5%9F%9F%E5%90%8D" class="level-3">关于网页授权的可信域名</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#%E5%85%B3%E4%BA%8Euserid%E6%9C%BA%E5%88%B6" class="level-3">关于UserID机制</a></li><li class="toc-li">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#%E7%BC%93%E5%AD%98%E6%96%B9%E6%A1%88%E5%BB%BA%E8%AE%AE" class="level-3">缓存方案建议</a></li></dir><p data-sign="6e21a0440035f98839ac2d4ece19d5ec" data-type="p" data-lines="3">企业微信提供了OAuth的授权登录方式，可以让从企业微信终端打开的网页获取成员的身份信息，从而免去登录的环节。<br>企业应用中的URL链接（包括自定义菜单或者消息中的链接），均可通过OAuth2.0验证接口来获取成员的UserId身份信息。</p><h2 id="oauth2%E7%AE%80%E4%BB%8B" data-sign="39b7178a340aba01e04895d96ad75df0" data-lines="2"><a class="anchor" href="#oauth2%E7%AE%80%E4%BB%8B"></a>OAuth2简介</h2><p data-sign="bcf9d4f6cc8c7fb109f2b8ddc6ee6317" data-type="p" data-lines="2">OAuth2的设计背景，在于允许用户在不告知第三方自己的账号密码情况下，通过授权方式，让第三方服务可以获取自己的资源信息。<br>详细的协议介绍，开发者可以参考<a href="https://tools.ietf.org/html/rfc6749" rel="nofollow">RFC 6749</a>。</p><div data-sign="3a5b2c71c8aac537d541f9c7447abd28" data-type="div" data-lines="3">下面简单说明OAuth2中最经典的Authorization Code模式，流程如下：<br><center><img src="images/91856/0964a356.png" alt=""></center></div><p data-sign="f9df81201b8546972cd0a24e45fd2f79" data-type="p" data-lines="1">流程图中，包含四个角色。</p><ul data-sign="a840d4fe7ab3e605dda6308aa4ae0037list4" data-lines="4" class="cherry-list__default"><li>ResourceOwner为资源所有者，即为用户</li><li>User-Agent为浏览器</li><li>AuthorizationServer为认证服务器，可以理解为用户资源托管方，比如企业微信服务端</li><li>Client为第三方服务</li></ul><p data-sign="f7ebe0620a557dfac5997d2de325bc85" data-type="p" data-lines="6">调用流程为：<br>A) 用户访问第三方服务，第三方服务通过构造OAuth2链接（参数包括当前第三方服务的身份ID，以及重定向URI），将用户引导到认证服务器的授权页<br>B) 用户选择是否同意授权<br>C) 若用户同意授权，则认证服务器将用户重向到第一步指定的重定向URI，同时附上一个授权码。<br>D) 第三方服务收到授权码，带上授权码来源的重定向URI，向认证服务器申请凭证。<br>E) 认证服务器检查授权码和重定向URI的有效性，通过后颁发AccessToken（调用凭证）</p><blockquote data-sign="804fc25124dd3e28042be62e0cd1b533_1" data-lines="1">D)与E)的调用为后台调用，不通过浏览器进行</blockquote><h2 id="%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1oauth2%E6%8E%A5%E5%85%A5%E6%B5%81%E7%A8%8B" data-sign="09c55328a1723b3269aa994e89c67eca" data-lines="2"><a class="anchor" href="#%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1oauth2%E6%8E%A5%E5%85%A5%E6%B5%81%E7%A8%8B"></a>企业微信OAuth2接入流程</h2><div data-sign="11600f15d43dbc5da6f54331cc5dd56a" data-type="div" data-lines="4"><center><img src="images/91856/309de8d9.png" alt="">图1 企业微信OAuth2流程图<br></center></div><h2 id="%E4%BD%BF%E7%94%A8oauth2%E5%89%8D%E9%A1%BB%E7%9F%A5" data-sign="86b5e4325e015e314eccdf8604c837e7" data-lines="2"><a class="anchor" href="#%E4%BD%BF%E7%94%A8oauth2%E5%89%8D%E9%A1%BB%E7%9F%A5"></a>使用OAuth2前须知</h2><h3 id="%E5%85%B3%E4%BA%8E%E7%BD%91%E9%A1%B5%E6%8E%88%E6%9D%83%E7%9A%84%E5%8F%AF%E4%BF%A1%E5%9F%9F%E5%90%8D" data-sign="72c58cb57c4af98e8b189c27171b362b" data-lines="2"><a class="anchor" href="#%E5%85%B3%E4%BA%8E%E7%BD%91%E9%A1%B5%E6%8E%88%E6%9D%83%E7%9A%84%E5%8F%AF%E4%BF%A1%E5%9F%9F%E5%90%8D"></a>关于网页授权的可信域名</h3><p data-sign="b09f0b6218c5204aab2d58284501b59b" data-type="p" data-lines="2">REDIRECT_URL中的域名，需要先配置至应用的“可信域名”，否则跳转时会提示“redirect_uri参数错误”。<br><strong>要求配置的可信域名，必须与访问链接的域名完全一致</strong>。举个例子：</p><ul data-sign="5d7b7eb51a40bd65f7256f440c1dcb4flist1" data-lines="1" class="cherry-list__default"><li>假定重定向访问的链接是：http://mail.qq.com:8080/cgi-bin/helloworld：</li></ul><div class="cherry-table-container" data-sign="ca01473fe79eaca5dd7b70cd51267c2c" data-lines="7">
        <table class="cherry-table"><thead><tr><th>配置域名</th><th>是否正确</th><th>原因</th></tr></thead><tbody><tr><td>mail.qq.com:8080</td><td><img src="images/91856/7ef305cb.png" alt="correct"></td><td>配置域名与访问域名完全一致</td></tr><tr><td>email.qq.com</td><td><img src="images/91856/3915fde3.png" alt="error"></td><td>配置域名必须与访问域名完全一致</td></tr><tr><td>support.mail.qq.com</td><td><img src="images/91856/3915fde3.png" alt="error"></td><td>配置域名必须与访问域名完全一致</td></tr><tr><td>*.qq.com</td><td><img src="images/91856/3915fde3.png" alt="error"></td><td>不支持泛域名设置</td></tr><tr><td>mail.qq.com</td><td><img src="images/91856/3915fde3.png" alt="error"></td><td>配置域名必须与访问域名完全一致，包括端口号</td></tr></tbody></table></div><ul data-sign="94f5f87865601d207421ce380655d2cdlist1" data-lines="1" class="cherry-list__default"><li>假定配置的可信域名是 mail.qq.com：</li></ul><div class="cherry-table-container" data-sign="6afa8312c80877908fd01e982135c352" data-lines="5">
        <table class="cherry-table"><thead><tr><th>访问链接</th><th>是否正确</th><th>原因</th></tr></thead><tbody><tr><td>https://mail.qq.com/cgi-bin/helloworld</td><td><img src="images/91856/7ef305cb.png" alt="correct"></td><td>配置域名与访问域名完全一致</td></tr><tr><td>http://mail.qq.com/cgi-bin/redirect</td><td><img src="images/91856/7ef305cb.png" alt="correct"></td><td>配置域名与访问域名完全一致，与协议头/链接路径无关</td></tr><tr><td>https://exmail.qq.com/cgi-bin/helloworld</td><td><img src="images/91856/3915fde3.png" alt="error"></td><td>配置域名必须与访问域名完全一致</td></tr></tbody></table></div><h3 id="%E5%85%B3%E4%BA%8Euserid%E6%9C%BA%E5%88%B6" data-sign="85605a3544ff5e96e6266b64b30122dd" data-lines="2"><a class="anchor" href="#%E5%85%B3%E4%BA%8Euserid%E6%9C%BA%E5%88%B6"></a>关于UserID机制</h3><p data-sign="9af348a80f33c730d0ed37313a186522" data-type="p" data-lines="1">UserId用于在一个企业内唯一标识一个用户，通过网页授权接口可以获取到当前用户的UserId信息，如果需要获取用户的更多信息可以调用 通讯录管理 - <a href="#10019" rel="nofollow">成员接口</a> 来获取。</p><h3 id="%E7%BC%93%E5%AD%98%E6%96%B9%E6%A1%88%E5%BB%BA%E8%AE%AE" data-sign="49b75dd8a0587d41c0dae100d55d4988" data-lines="2"><a class="anchor" href="#%E7%BC%93%E5%AD%98%E6%96%B9%E6%A1%88%E5%BB%BA%E8%AE%AE"></a>缓存方案建议</h3><p data-sign="7572d75fb71ba4f2be8ad836ca01b31d" data-type="p" data-lines="5">通过OAuth2.0验证接口获取成员身份会有一定的时间开销。对于频繁获取成员身份的场景，建议采用如下方案：<br>1、企业应用中的URL链接直接填写企业自己的页面地址<br>2、成员操作跳转到步骤1的企业页面时，企业后台校验是否有标识成员身份的cookie信息，此cookie由企业生成<br>3、如果没有匹配的cookie，则重定向到OAuth验证链接，获取成员的身份信息后，由企业后台植入标识成员身份的cookie信息<br>4、根据cookie获取成员身份后，再进入相应的页面</p></div></div>
    </div>
                <script src="../doc-script.js"></script>
                
                
                </body></html>