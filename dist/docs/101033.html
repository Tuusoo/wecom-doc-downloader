<!DOCTYPE html><html lang="zh-CN"><head>
                <meta charset="UTF-8">
                <title>回调和回复的加解密方案 - 文档 - 企业微信开发者中心</title>
                <link rel="stylesheet" href="../doc-style.css">
                </head>
                <body>
                <div id="js-ep-doc-cnt" class="ep-doc-area-cnt">
    <div class="ep-doc-area-top" id="js-ep-doc-cnt-title">
      <div class="ep-doc-area-title">
        回调和回复的加解密方案
      </div>
      <div class="ep-doc-area-subtitle">最后更新：2025/07/23</div>
    </div>
    <div class="ep-doc-area-cherry cherry-markdown cherry-wecom" id="js-ep-doc-cnt-md"><div data-inline-code-theme="red" data-code-block-theme="coy"><dir class="toc" data-sign="2f2fa0fa810f6caae0e55b2d709f5fdd-1" data-lines="1"><p class="toc-title">目录</p><li class="toc-li"><a href="#%E9%AA%8C%E8%AF%81url%E6%9C%89%E6%95%88%E6%80%A7" class="level-2">验证URL有效性</a></li><li class="toc-li"><a href="#%E6%8E%A5%E6%94%B6%E5%9B%9E%E8%B0%83%E8%A7%A3%E5%AF%86" class="level-2">接收回调解密</a></li><li class="toc-li"><a href="#%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A2%AB%E5%8A%A8%E5%9B%9E%E5%A4%8D" class="level-2">加密与被动回复</a></li></dir><h2 id="%E9%AA%8C%E8%AF%81url%E6%9C%89%E6%95%88%E6%80%A7" data-sign="5dd970d6f4e111ebc97a70742360cf07" data-lines="2"><a class="anchor" href="#%E9%AA%8C%E8%AF%81url%E6%9C%89%E6%95%88%E6%80%A7"></a>验证URL有效性</h2><p data-sign="dd0756b5a5ca95ba652331f1e8b5d918" data-type="p" data-lines="2">当点击“保存”提交开发配置信息时，企业微信会发送一条验证消息到填写的URL，发送方法为<font color="red"><strong>GET</strong></font>。<br>智能机器人的接收消息服务器接收到验证请求后，需要作出正确的响应才能通过URL验证。</p><blockquote data-sign="b22c4eb7883078f25ed4a088330b96cd_1" data-lines="1">获取请求参数时<font color="red">需要做Urldecode处理</font>，否则会验证不成功</blockquote><p data-sign="89d4a8789ca70f70558c4261fdffacd7" data-type="p" data-lines="2">假设接收消息地址设置为：https://api.3dept.com/，企业微信将向该地址发送如下验证请求：</p><p data-sign="dc7c3640f86fb3fb7b95165abfc2b5fe" data-type="p" data-lines="2"><strong>请求方式：GET</strong></p><p data-sign="3f531abaa067daa387bd4e7a83a0489c" data-type="p" data-lines="3"><strong>请求地址</strong>：https://api.3dept.com/?msg_signature=ASDFQWEXZCVAQFASDFASDFSS&amp;timestamp=13500001234&amp;nonce=123412323&amp;echostr=ENCRYPT_STR<br><strong>参数说明</strong></p><div class="cherry-table-container" data-sign="5b9f55e21a7f8ca58bd08779997d5529" data-lines="6">
        <table class="cherry-table"><thead><tr><th>参数</th><th>必须</th><th>说明</th></tr></thead><tbody><tr><td>msg_signature</td><td>是</td><td>企业微信加密签名，msg_signature结合了开发者填写的token、请求中的timestamp、nonce参数、加密的消息体</td></tr><tr><td>timestamp</td><td>是</td><td>时间戳</td></tr><tr><td>nonce</td><td>是</td><td>随机数，两个小时内保证不重复</td></tr><tr><td>echostr</td><td>是</td><td>加密的字符串。需要<a href="#12976/%E5%AF%86%E6%96%87%E8%A7%A3%E5%AF%86%E5%BE%97%E5%88%B0msg%E7%9A%84%E8%BF%87%E7%A8%8B" rel="nofollow">解密得到消息内容明文</a>，解密后有random、msg_len、msg三个字段，其中msg即为消息内容明文</td></tr></tbody></table></div><p data-sign="c0757ccddb2351e16198b47bef074808" data-type="p" data-lines="1">智能机器人后台收到请求后，需要做如下操作：</p><ol data-sign="868ead264cffa0fdaa6a738c2a45376elist4" data-lines="4" class="cherry-list__default" start="1"><li>对收到的请求做Urldecode处理</li><li>通过参数msg_signature<a href="#12976/%E6%B6%88%E6%81%AF%E4%BD%93%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C" rel="nofollow">对请求进行校验</a>，确认调用者的合法性。</li><li><a href="#12976/%E5%AF%86%E6%96%87%E8%A7%A3%E5%AF%86%E5%BE%97%E5%88%B0msg%E7%9A%84%E8%BF%87%E7%A8%8B" rel="nofollow">解密echostr</a>参数得到消息内容(即msg字段)</li><li>在<font color="red">1秒内</font>响应GET请求，响应内容为上一步得到的明文消息内容(<font color="red">不能加引号，不能带bom头，不能带换行符</font>)</li></ol><p data-sign="61218f9709d02148d61531a69fafa413" data-type="p" data-lines="2">以上2~3步骤可以直接使用<a href="#12976/%E9%AA%8C%E8%AF%81URL%E5%87%BD%E6%95%B0" rel="nofollow">验证URL函数</a>一步到位。<br>之后接入验证生效，接收消息开启成功。</p><blockquote data-sign="009a59441c8630a3eca0dcb878cb6212_1" data-lines="1">企业内部智能机器人场景中，ReceiveId为""<br></blockquote><h2 id="%E6%8E%A5%E6%94%B6%E5%9B%9E%E8%B0%83%E8%A7%A3%E5%AF%86" data-sign="52de6eb7a10db7beeca3dfd131f0d3de" data-lines="2"><a class="anchor" href="#%E6%8E%A5%E6%94%B6%E5%9B%9E%E8%B0%83%E8%A7%A3%E5%AF%86"></a>接收回调解密</h2><p data-sign="79915aaa8fe50a5f7ffe90f7bc46df20" data-type="p" data-lines="2"><strong>智能机器人的回调格式为json</strong>，参考<strong>接收数据格式</strong>说明。开发者可以直接使用企业微信为应用提供的<a href="#12976" rel="nofollow">加解密库</a>（目前已有c++/python/php/java/c#等语言版本）解密encrypt字段，获取事件明文json报文。<strong>需要注意的是，加解密库要求传 receiveid 参数，企业自建智能机器人的使用场景里，receiveid直接传空字符串即可；<!--第三方智能机器人 receiveid 参数为智能机器人BotId(即tousername对应的字段)</strong>-->。</strong></p><p data-sign="bdf3211db544e18930019cdbfd11f589" data-type="p" data-lines="1"><strong><strong>加密数据格式 ：</strong></strong></p><div data-sign="41133471c889eb7df7430464634b0dac" data-type="codeBlock" data-lines="5"><strong>
      <pre class="language-javascript"><code class="language-javascript wrap"><span class="code-line"><span class="token punctuation">{</span></span>
<span class="code-line">	<span class="token string">"encrypt"</span><span class="token operator">:</span> <span class="token string">"msg_encrypt"</span></span>
<span class="code-line"><span class="token punctuation">}</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </strong></div><p data-sign="54d2f7abd4f226094d9bdd35b3129b56" data-type="p" data-lines="2"><strong><strong>参数说明</strong></strong></p><div class="cherry-table-container" data-sign="657489282f3c14b55c6dbfd568ce1227" data-lines="3"><strong>
        <table class="cherry-table"><thead><tr><th>参数</th><th>是否必填</th><th>说明</th></tr></thead><tbody><tr><td>encrypt</td><td>是</td><td>消息结构体加密后的字符串</td></tr></tbody></table></strong></div><p data-sign="b4294b9876c6b85a1b58ab2dddc8ae98" data-type="p" data-lines="1"><!--| tousername | 否|智能机器人ID，仅当为第三方智能机器人时，填该字段 |--></p><h2 id="%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A2%AB%E5%8A%A8%E5%9B%9E%E5%A4%8D" data-sign="22e68cc67f36b49abeca5eed9d79469a" data-lines="2"><a class="anchor" href="#%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A2%AB%E5%8A%A8%E5%9B%9E%E5%A4%8D"></a>加密与被动回复</h2><p data-sign="518b8efb3a6afffed6e641347c627c60" data-type="p" data-lines="1">开发者解密数据得到用户消息内容后，可以选择直接回复空包，也可以在响应本次请求的时候直接回复消息。回复的消息需要先按<a href="#59068" rel="nofollow">明文协议</a>构造json数据包，然后对明文消息进行加密，然后填充到下述协议中的encrypt字段中，之后再回复最终的密文json数据包。加密过程参见“<a href="#12976/%E6%98%8E%E6%96%87msg%E7%9A%84%E5%8A%A0%E5%AF%86%E8%BF%87%E7%A8%8B" rel="nofollow">明文msg的加密过程</a>”。</p><p data-sign="cc47e065e0ec97c889d0a09305278a31" data-type="p" data-lines="1"><strong>加密数据格式:</strong></p><div data-sign="e45903f8daf5cb352930908730fb2bb1" data-type="codeBlock" data-lines="8">
      <pre class="language-javascript"><code class="language-javascript wrap"><span class="code-line"><span class="token punctuation">{</span></span>
<span class="code-line">	<span class="token string">"encrypt"</span><span class="token operator">:</span> <span class="token string">"msg_encrypt"</span><span class="token punctuation">,</span></span>
<span class="code-line">	<span class="token string">"msgsignature"</span><span class="token operator">:</span> <span class="token string">"msg_signaturet"</span><span class="token punctuation">,</span></span>
<span class="code-line">	<span class="token string">"timestamp"</span><span class="token operator">:</span> <span class="token number">1641002400</span><span class="token punctuation">,</span></span>
<span class="code-line">	<span class="token string">"nonce"</span><span class="token operator">:</span> <span class="token string">"nonce"</span></span>
<span class="code-line"><span class="token punctuation">}</span></span></code><div class="codeCopyBtn"></div><div class="codeCopyBtn_tips">点击复制</div></pre>
    </div><p data-sign="f2e21495051cadd2d5b0f8a3eedbae8d" data-type="p" data-lines="1"><strong>参数说明：</strong></p><div class="cherry-table-container" data-sign="b150a4b7550f4a9dba9ed5e9667241be" data-lines="6">
        <table class="cherry-table"><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>encrypt</td><td>是</td><td>加密后的消息内容</td></tr><tr><td>msgsignature</td><td>是</td><td>消息签名</td></tr><tr><td>timestamp</td><td>是</td><td>时间戳，要求为秒级别的</td></tr><tr><td>nonce</td><td>是</td><td>随机数，需要用回调url中的nonce</td></tr></tbody></table></div></div></div>
    </div>
                <script src="../doc-script.js"></script>
                
                
                </body></html>